#!/usr/bin/env node

const path = require('path')
const program = require('commander')
const express = require('express')
const bodyParser = require('body-parser')
const cors = require('cors')
const portfinder = require('portfinder')
const chalk = require('chalk')
const connectMockMiddleware = require('connect-mock-middleware')
const host = require('../lib/host')

const app = express()
const collect = function () {
  const prefix = []
  return (value) => {
    const lastSlashIndex = value.lastIndexOf('/')

    if (lastSlashIndex > -1) {
      value = value.slice(lastSlashIndex)
    } else {
      value = `/${value}`
    }

    prefix.push(value)
    return prefix
  }
}

program
  .usage('mock [<option>]')
  .option('-d, --dir <s>', 'Mock directory pathname, default mock', 'mock')
  .option('-P, --prefix <s>', 'Intercept url, default "/*"', collect(), '/*')
  .option('-p, --port <n>', 'Mock server port, default 3721', Number, 3721)
  .option('-c --callback <s>', 'Jsonp callback name, default callback', 'callback')

program.parse(process.argv)

app.set('jsonp callback name', program.callback)
app.use(cors({
  origin: (origin, callback) => {
    callback(null, true)
  },
  credentials: true,
  optionsSuccessStatus: 200
}))
app.use(bodyParser.urlencoded({ extended: false }))
app.use(bodyParser.json())
app.use(connectMockMiddleware(path.resolve(program.dir), {
  prefix: program.prefix,
  callback: program.callback
}))

portfinder.basePort = program.port
portfinder.getPort((err, port) => {
  if (err) throw err
  app.listen(port, host, () => {
    console.log(chalk.gray('Mock server start onï¼š'), chalk.underline.green(`http://${host}:${port}\n`))
  })
})
